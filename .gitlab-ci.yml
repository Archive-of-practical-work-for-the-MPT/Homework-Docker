stages:
  - build
  - linter
  - test

variables:
  DJANGO_SETTINGS_MODULE: "greenquality.settings"
  VENV_PATH: ".venv"
  DB_NAME: "test_greenquality"
  DB_USER: "postgres"
  DB_PASSWORD: "postgres"
  DB_HOST: "localhost"
  DB_PORT: "5432"

default:
  before_script:
    # Создание виртуального окружения
    - python3 -m venv $VENV_PATH
    - . $VENV_PATH/bin/activate
    # Обновление pip и установка зависимостей
    - python3 -m pip install --upgrade pip
    - pip install -r requirements.txt
    # Копирование примера .env файла
    - cp .env.example .env
    # Запуск тестовой базы данных (если используется Docker)
    - echo "Подготовка тестовой среды"

# Проверка сборки проекта
build-check:
  stage: build
  script:
    - echo "Проверка сборки проекта GreenQuality"
    # Проверка конфигурации Django
    - python3 greenquality/manage.py check
    # Проверка миграций
    - python3 greenquality/manage.py makemigrations --check --dry-run
    - echo "Проект успешно собран"

# Проверка синтаксических ошибок линтером
linter-check:
  stage: linter
  rules: 
    - allow_failure: true
  script:
    - echo "Проверка синтаксических ошибок с помощью flake8"
    - pip install flake8
    - python3 -m flake8 greenquality/
    - echo "Проверка синтаксических ошибок завершена"

# Анализ качества кода
code-quality:
  stage: test
  rules: 
    - allow_failure: true
  script:
    - echo "Анализ качества кода проекта GreenQuality"
    - pip install radon mccabe
    # Анализ цикломатической сложности
    - python3 -m radon cc greenquality/ -a
    # Анализ объема кода
    - python3 -m radon raw greenquality/
    - echo "Анализ качества кода завершен"

# Проверка безопасности кода
security-check:
  stage: test
  rules: 
    - allow_failure: true
  script:
    - echo "Проверка безопасности кода"
    - pip install bandit
    # Статический анализ безопасности кода
    - bandit -r greenquality/ -ll
    - echo "Проверка безопасности завершена"